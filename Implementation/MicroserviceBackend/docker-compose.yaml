version: "3.9"

###############################################################################
#  Infrastructure containers (databases, broker)                               #
###############################################################################
services:
  # ───────── RabbitMQ ────────────────────────────────────────────────────────
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    restart: unless-stopped
    ports:
      - "5672:5672"      # AMQP
      - "15672:15672"    # Management UI
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ───────── Postgres for the *authentication* service ──────────────────────
  authdb:
    image: postgres:latest
    restart: unless-stopped
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: authdb
    volumes:
      - authdb-data:/var/lib/postgresql/data
    ports:               
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d authdb"]
      interval: 10s
      timeout: 5s
      retries: 3
    # ^ No ports → stays internal; expose only if you *really*
    #   want to reach it from a desktop SQL client

  # ───────── Postgres for the *user* service ────────────────────────────────
  userdb:
    image: postgres:latest
    restart: unless-stopped
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: userdb
    volumes:
      - userdb-data:/var/lib/postgresql/data
    ports:               
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d userdb"]
      interval: 10s
      timeout: 5s
      retries: 3

###############################################################################
#  Micro‑services (runtime images – use override file for hot reload)          #
###############################################################################
  auth-svc:
    build:
      context: ./AuthenticationService
      target: runtime
    environment:
      PORT: 3000
      DATABASE_URL: postgres://app:secret@authdb:5432/authdb
      RABBITMQ_URL: amqp://rabbitmq:5672
      ACCESS_SECRET: dev_access_secret
      REFRESH_SECRET: dev_refresh_secret
    depends_on:
      authdb:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  user-svc:
    build:
      context: ./UserService
      target: runtime
    environment:
      PORT: 3001
      DATABASE_URL: postgres://app:secret@userdb:5432/userdb
      RABBITMQ_URL: amqp://rabbitmq:5672
    depends_on:
      userdb:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      retries: 3

###############################################################################
#  Persist database files between runs                                         #
###############################################################################
volumes:
  authdb-data:
  userdb-data:
